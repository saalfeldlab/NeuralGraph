#!/bin/bash
# Pre-commit hook to check file sizes and run ruff check
# This runs the same check as the GitHub workflow

# Configuration
MAX_FILE_SIZE=512000  # 500KB in bytes
MAX_NOTEBOOK_SIZE=2097152  # 2MB in bytes
HOOK_VENV_DIR=".git/hooks-venv"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# 1. Check file sizes
echo ""
echo "Checking file sizes..."
files_too_large=()

# Get list of staged files
while IFS= read -r file; do
    if [ -f "$file" ]; then
        file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)

        if [[ "$file" == *.ipynb ]]; then
            # Notebook files have a 2MB limit
            if [ "$file_size" -gt "$MAX_NOTEBOOK_SIZE" ]; then
                files_too_large+=("$file ($(numfmt --to=iec-i --suffix=B $file_size) > 2MB)")
            fi
        else
            # Regular files have a 500KB limit
            if [ "$file_size" -gt "$MAX_FILE_SIZE" ]; then
                files_too_large+=("$file ($(numfmt --to=iec-i --suffix=B $file_size) > 500KB)")
            fi
        fi
    fi
done < <(git diff --cached --name-only --diff-filter=ACM)

if [ ${#files_too_large[@]} -gt 0 ]; then
    echo -e "${RED}Error: The following files exceed size limits:${NC}"
    printf '%s\n' "${files_too_large[@]}"
    echo ""
    echo "File size limits:"
    echo "  - Regular files: 500KB (configurable via MAX_FILE_SIZE)"
    echo "  - Notebook files (*.ipynb): 2MB (configurable via MAX_NOTEBOOK_SIZE)"
    echo ""
    echo "Please reduce file sizes or update the configuration if needed."
    exit 1
fi

echo -e "${GREEN}File size check passed!${NC}"

# 2. Setup ruff in a local virtual environment
echo ""
echo "Setting up ruff..."

# Check if virtual environment exists
if [ ! -d "$HOOK_VENV_DIR" ]; then
    echo "Creating virtual environment for hooks in $HOOK_VENV_DIR..."
    python3 -m venv "$HOOK_VENV_DIR"

    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Failed to create virtual environment.${NC}"
        echo "Please ensure python3 and venv are installed."
        exit 1
    fi
fi

# Activate the virtual environment
source "$HOOK_VENV_DIR/bin/activate"

# Check if ruff is installed, install if not
if ! command -v ruff &> /dev/null; then
    echo "Installing ruff..."
    pip install --quiet ruff

    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Failed to install ruff.${NC}"
        deactivate
        exit 1
    fi
    echo -e "${GREEN}Ruff installed successfully!${NC}"
fi

# 3. Run ruff check
echo ""
echo "Running ruff check..."

# Run ruff check
ruff check . --exclude '*.ipynb'

if [ $? -ne 0 ]; then
    echo ""
    echo -e "${RED}Ruff check failed. Please fix the issues before committing.${NC}"
    echo ""
    echo -e "${YELLOW}To fix the issues, run:${NC}"
    echo "  ruff check . --exclude '*.ipynb' --fix"
    deactivate
    exit 1
fi

# Deactivate the virtual environment
deactivate

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
